{"ast":null,"code":"var _construct = require(\"/Users/suryanandsunil/Desktop/proto1-arizon/lyo-test/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/construct\");\n\nvar _createForOfIteratorHelper = require(\"/Users/suryanandsunil/Desktop/proto1-arizon/lyo-test/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/createForOfIteratorHelper\");\n\nvar _regeneratorRuntime = require(\"/Users/suryanandsunil/Desktop/proto1-arizon/lyo-test/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\");\n\nvar _asyncToGenerator = require(\"/Users/suryanandsunil/Desktop/proto1-arizon/lyo-test/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/asyncToGenerator\");\n\nvar _toConsumableArray = require(\"/Users/suryanandsunil/Desktop/proto1-arizon/lyo-test/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/toConsumableArray\");\n\nvar _classCallCheck = require(\"/Users/suryanandsunil/Desktop/proto1-arizon/lyo-test/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/classCallCheck\");\n\nvar _createClass = require(\"/Users/suryanandsunil/Desktop/proto1-arizon/lyo-test/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/createClass\");\n\nvar _require = require('util'),\n    inspect = _require.inspect;\n\nvar isObject = require('../help/is_object');\n\nvar _require2 = require('../jwk/generate'),\n    _generate = _require2.generate,\n    _generateSync = _require2.generateSync;\n\nvar _require3 = require('../help/consts'),\n    USES_MAPPING = _require3.USES_MAPPING;\n\nvar _require4 = require('../jwk'),\n    isKey = _require4.isKey,\n    importKey = _require4.asKey;\n\nvar keyscore = function keyscore(key, _ref) {\n  var alg = _ref.alg,\n      use = _ref.use,\n      ops = _ref.ops;\n  var score = 0;\n\n  if (alg && key.alg) {\n    score++;\n  }\n\n  if (use && key.use) {\n    score++;\n  }\n\n  if (ops && key.key_ops) {\n    score++;\n  }\n\n  return score;\n};\n\nvar KeyStore = /*#__PURE__*/function () {\n  \"use strict\";\n\n  function KeyStore() {\n    for (var _len = arguments.length, keys = new Array(_len), _key = 0; _key < _len; _key++) {\n      keys[_key] = arguments[_key];\n    }\n\n    _classCallCheck(this, KeyStore);\n\n    while (keys.some(Array.isArray)) {\n      keys = keys.flat ? keys.flat() : keys.reduce(function (acc, val) {\n        if (Array.isArray(val)) {\n          return [].concat(_toConsumableArray(acc), _toConsumableArray(val));\n        }\n\n        acc.push(val);\n        return acc;\n      }, []);\n    }\n\n    if (keys.some(function (k) {\n      return !isKey(k) || !k.kty;\n    })) {\n      throw new TypeError('all keys must be instances of a key instantiated by JWK.asKey');\n    }\n\n    this._keys = new Set(keys);\n  }\n\n  _createClass(KeyStore, [{\n    key: \"all\",\n    value: function all() {\n      var _ref2 = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {},\n          alg = _ref2.alg,\n          kid = _ref2.kid,\n          thumbprint = _ref2.thumbprint,\n          use = _ref2.use,\n          kty = _ref2.kty,\n          ops = _ref2.key_ops,\n          x5t = _ref2.x5t,\n          x5t256 = _ref2['x5t#S256'],\n          crv = _ref2.crv;\n\n      if (ops !== undefined && (!Array.isArray(ops) || !ops.length || ops.some(function (x) {\n        return typeof x !== 'string';\n      }))) {\n        throw new TypeError('`key_ops` must be a non-empty array of strings');\n      }\n\n      var search = {\n        alg: alg,\n        use: use,\n        ops: ops\n      };\n      return _toConsumableArray(this._keys).filter(function (key) {\n        var candidate = true;\n\n        if (candidate && kid !== undefined && key.kid !== kid) {\n          candidate = false;\n        }\n\n        if (candidate && thumbprint !== undefined && key.thumbprint !== thumbprint) {\n          candidate = false;\n        }\n\n        if (candidate && x5t !== undefined && key.x5t !== x5t) {\n          candidate = false;\n        }\n\n        if (candidate && x5t256 !== undefined && key['x5t#S256'] !== x5t256) {\n          candidate = false;\n        }\n\n        if (candidate && kty !== undefined && key.kty !== kty) {\n          candidate = false;\n        }\n\n        if (candidate && crv !== undefined && key.crv !== crv) {\n          candidate = false;\n        }\n\n        if (alg !== undefined && !key.algorithms().has(alg)) {\n          candidate = false;\n        }\n\n        if (candidate && use !== undefined && key.use !== undefined && key.use !== use) {\n          candidate = false;\n        } // TODO:\n\n\n        if (candidate && ops !== undefined && (key.key_ops !== undefined || key.use !== undefined)) {\n          var keyOps;\n\n          if (key.key_ops) {\n            keyOps = new Set(key.key_ops);\n          } else {\n            keyOps = USES_MAPPING[key.use];\n          }\n\n          if (ops.some(function (x) {\n            return !keyOps.has(x);\n          })) {\n            candidate = false;\n          }\n        }\n\n        return candidate;\n      }).sort(function (first, second) {\n        return keyscore(second, search) - keyscore(first, search);\n      });\n    }\n  }, {\n    key: \"get\",\n    value: function get() {\n      return this.all.apply(this, arguments)[0];\n    }\n  }, {\n    key: \"add\",\n    value: function add(key) {\n      if (!isKey(key) || !key.kty) {\n        throw new TypeError('key must be an instance of a key instantiated by JWK.asKey');\n      }\n\n      this._keys.add(key);\n    }\n  }, {\n    key: \"remove\",\n    value: function remove(key) {\n      if (!isKey(key)) {\n        throw new TypeError('key must be an instance of a key instantiated by JWK.asKey');\n      }\n\n      this._keys.delete(key);\n    }\n  }, {\n    key: \"toJWKS\",\n    value: function toJWKS() {\n      var priv = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : false;\n      return {\n        keys: _toConsumableArray(this._keys.values()).map(function (key) {\n          return key.toJWK(priv && (key.private || key.secret && key.k));\n        })\n      };\n    }\n  }, {\n    key: \"generate\",\n    value: function () {\n      var _generate2 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee() {\n        var _args = arguments;\n        return _regeneratorRuntime.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                _context.t0 = this._keys;\n                _context.next = 3;\n                return _generate.apply(void 0, _args);\n\n              case 3:\n                _context.t1 = _context.sent;\n\n                _context.t0.add.call(_context.t0, _context.t1);\n\n              case 5:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee, this);\n      }));\n\n      function generate() {\n        return _generate2.apply(this, arguments);\n      }\n\n      return generate;\n    }()\n  }, {\n    key: \"generateSync\",\n    value: function generateSync() {\n      this._keys.add(_generateSync.apply(void 0, arguments));\n    }\n  }, {\n    key: \"size\",\n    get: function get() {\n      return this._keys.size;\n    }\n    /* c8 ignore next 8 */\n\n  }, {\n    key: inspect.custom,\n    value: function value() {\n      return \"\".concat(this.constructor.name, \" \").concat(inspect(this.toJWKS(false), {\n        depth: Infinity,\n        colors: process.stdout.isTTY,\n        compact: false,\n        sorted: true\n      }));\n    }\n  }, {\n    key: Symbol.iterator,\n    value: /*#__PURE__*/_regeneratorRuntime.mark(function value() {\n      var _iterator, _step, key;\n\n      return _regeneratorRuntime.wrap(function value$(_context2) {\n        while (1) {\n          switch (_context2.prev = _context2.next) {\n            case 0:\n              _iterator = _createForOfIteratorHelper(this._keys);\n              _context2.prev = 1;\n\n              _iterator.s();\n\n            case 3:\n              if ((_step = _iterator.n()).done) {\n                _context2.next = 9;\n                break;\n              }\n\n              key = _step.value;\n              _context2.next = 7;\n              return key;\n\n            case 7:\n              _context2.next = 3;\n              break;\n\n            case 9:\n              _context2.next = 14;\n              break;\n\n            case 11:\n              _context2.prev = 11;\n              _context2.t0 = _context2[\"catch\"](1);\n\n              _iterator.e(_context2.t0);\n\n            case 14:\n              _context2.prev = 14;\n\n              _iterator.f();\n\n              return _context2.finish(14);\n\n            case 17:\n            case \"end\":\n              return _context2.stop();\n          }\n        }\n      }, value, this, [[1, 11, 14, 17]]);\n    })\n  }]);\n\n  return KeyStore;\n}();\n\nfunction asKeyStore(jwks) {\n  var _ref3 = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {},\n      _ref3$ignoreErrors = _ref3.ignoreErrors,\n      ignoreErrors = _ref3$ignoreErrors === void 0 ? false : _ref3$ignoreErrors,\n      _ref3$calculateMissin = _ref3.calculateMissingRSAPrimes,\n      calculateMissingRSAPrimes = _ref3$calculateMissin === void 0 ? false : _ref3$calculateMissin;\n\n  if (!isObject(jwks) || !Array.isArray(jwks.keys) || jwks.keys.some(function (k) {\n    return !isObject(k) || !('kty' in k);\n  })) {\n    throw new TypeError('jwks must be a JSON Web Key Set formatted object');\n  }\n\n  var keys = jwks.keys.map(function (jwk) {\n    try {\n      return importKey(jwk, {\n        calculateMissingRSAPrimes: calculateMissingRSAPrimes\n      });\n    } catch (err) {\n      if (!ignoreErrors) {\n        throw err;\n      }\n\n      return undefined;\n    }\n  }).filter(Boolean);\n  return _construct(KeyStore, _toConsumableArray(keys));\n}\n\nmodule.exports = {\n  KeyStore: KeyStore,\n  asKeyStore: asKeyStore\n};","map":{"version":3,"sources":["/Users/suryanandsunil/Desktop/proto1-arizon/lyo-test/node_modules/jose/lib/jwks/keystore.js"],"names":["require","inspect","isObject","generate","generateSync","USES_MAPPING","isKey","importKey","asKey","keyscore","key","alg","use","ops","score","key_ops","KeyStore","keys","some","Array","isArray","flat","reduce","acc","val","push","k","kty","TypeError","_keys","Set","kid","thumbprint","x5t","x5t256","crv","undefined","length","x","search","filter","candidate","algorithms","has","keyOps","sort","first","second","all","add","delete","priv","values","map","toJWK","private","secret","size","custom","constructor","name","toJWKS","depth","Infinity","colors","process","stdout","isTTY","compact","sorted","Symbol","iterator","asKeyStore","jwks","ignoreErrors","calculateMissingRSAPrimes","jwk","err","Boolean","module","exports"],"mappings":"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","sourcesContent":["const { inspect } = require('util')\n\nconst isObject = require('../help/is_object')\nconst { generate, generateSync } = require('../jwk/generate')\nconst { USES_MAPPING } = require('../help/consts')\nconst { isKey, asKey: importKey } = require('../jwk')\n\nconst keyscore = (key, { alg, use, ops }) => {\n  let score = 0\n\n  if (alg && key.alg) {\n    score++\n  }\n\n  if (use && key.use) {\n    score++\n  }\n\n  if (ops && key.key_ops) {\n    score++\n  }\n\n  return score\n}\n\nclass KeyStore {\n  constructor (...keys) {\n    while (keys.some(Array.isArray)) {\n      keys = keys.flat\n        ? keys.flat()\n        : keys.reduce((acc, val) => {\n          if (Array.isArray(val)) {\n            return [...acc, ...val]\n          }\n\n          acc.push(val)\n          return acc\n        }, [])\n    }\n    if (keys.some(k => !isKey(k) || !k.kty)) {\n      throw new TypeError('all keys must be instances of a key instantiated by JWK.asKey')\n    }\n\n    this._keys = new Set(keys)\n  }\n\n  all ({ alg, kid, thumbprint, use, kty, key_ops: ops, x5t, 'x5t#S256': x5t256, crv } = {}) {\n    if (ops !== undefined && (!Array.isArray(ops) || !ops.length || ops.some(x => typeof x !== 'string'))) {\n      throw new TypeError('`key_ops` must be a non-empty array of strings')\n    }\n\n    const search = { alg, use, ops }\n    return [...this._keys]\n      .filter((key) => {\n        let candidate = true\n\n        if (candidate && kid !== undefined && key.kid !== kid) {\n          candidate = false\n        }\n\n        if (candidate && thumbprint !== undefined && key.thumbprint !== thumbprint) {\n          candidate = false\n        }\n\n        if (candidate && x5t !== undefined && key.x5t !== x5t) {\n          candidate = false\n        }\n\n        if (candidate && x5t256 !== undefined && key['x5t#S256'] !== x5t256) {\n          candidate = false\n        }\n\n        if (candidate && kty !== undefined && key.kty !== kty) {\n          candidate = false\n        }\n\n        if (candidate && crv !== undefined && (key.crv !== crv)) {\n          candidate = false\n        }\n\n        if (alg !== undefined && !key.algorithms().has(alg)) {\n          candidate = false\n        }\n\n        if (candidate && use !== undefined && (key.use !== undefined && key.use !== use)) {\n          candidate = false\n        }\n\n        // TODO:\n        if (candidate && ops !== undefined && (key.key_ops !== undefined || key.use !== undefined)) {\n          let keyOps\n          if (key.key_ops) {\n            keyOps = new Set(key.key_ops)\n          } else {\n            keyOps = USES_MAPPING[key.use]\n          }\n          if (ops.some(x => !keyOps.has(x))) {\n            candidate = false\n          }\n        }\n\n        return candidate\n      })\n      .sort((first, second) => keyscore(second, search) - keyscore(first, search))\n  }\n\n  get (...args) {\n    return this.all(...args)[0]\n  }\n\n  add (key) {\n    if (!isKey(key) || !key.kty) {\n      throw new TypeError('key must be an instance of a key instantiated by JWK.asKey')\n    }\n\n    this._keys.add(key)\n  }\n\n  remove (key) {\n    if (!isKey(key)) {\n      throw new TypeError('key must be an instance of a key instantiated by JWK.asKey')\n    }\n\n    this._keys.delete(key)\n  }\n\n  toJWKS (priv = false) {\n    return {\n      keys: [...this._keys.values()].map(\n        key => key.toJWK(priv && (key.private || (key.secret && key.k)))\n      )\n    }\n  }\n\n  async generate (...args) {\n    this._keys.add(await generate(...args))\n  }\n\n  generateSync (...args) {\n    this._keys.add(generateSync(...args))\n  }\n\n  get size () {\n    return this._keys.size\n  }\n\n  /* c8 ignore next 8 */\n  [inspect.custom] () {\n    return `${this.constructor.name} ${inspect(this.toJWKS(false), {\n      depth: Infinity,\n      colors: process.stdout.isTTY,\n      compact: false,\n      sorted: true\n    })}`\n  }\n\n  * [Symbol.iterator] () {\n    for (const key of this._keys) {\n      yield key\n    }\n  }\n}\n\nfunction asKeyStore (jwks, { ignoreErrors = false, calculateMissingRSAPrimes = false } = {}) {\n  if (!isObject(jwks) || !Array.isArray(jwks.keys) || jwks.keys.some(k => !isObject(k) || !('kty' in k))) {\n    throw new TypeError('jwks must be a JSON Web Key Set formatted object')\n  }\n\n  const keys = jwks.keys.map((jwk) => {\n    try {\n      return importKey(jwk, { calculateMissingRSAPrimes })\n    } catch (err) {\n      if (!ignoreErrors) {\n        throw err\n      }\n      return undefined\n    }\n  }).filter(Boolean)\n\n  return new KeyStore(...keys)\n}\n\nmodule.exports = { KeyStore, asKeyStore }\n"]},"metadata":{},"sourceType":"script"}